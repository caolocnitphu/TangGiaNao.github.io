<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Game N√¥ng Tr·∫°i - TƒÉng Gia N√†o</title>
  <style>
    :root {
      --primary-color: #ff6347;
      --modal-bg: rgba(255, 255, 255, 0.9);
      --overlay-bg: rgba(0, 0, 0, 0.5);
    }

    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
      touch-action: manipulation; /* T·ªëi ∆∞u touch */
    }

    #game-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100vw;
      height: 100vh;
      background-color: #f0f0f0;
      overflow: hidden;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(10, minmax(0, 1fr));
      grid-template-rows: repeat(10, minmax(0, 1fr));
      width: 100%;
      height: 100%;
      max-width: 100vw;
      max-height: 100vh;
    }

    .cell {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: clamp(1em, 4vw, 2em);
      position: relative;
      border: 1px solid #ccc;
    }

    .grass { background-color: green; }
    .plantable { background-color: brown; }
    .locked { background-color: gray; }
    .locked::after { content: 'üîí'; font-size: 1em; position: absolute; }

    #character {
      position: absolute;
      width: calc(var(--cell-size, 10vw));
      height: calc(var(--cell-size, 10vw));
      background-color: transparent;
      border-radius: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: calc(var(--cell-size, 10vw) * 0.6);
      transition: top 0.2s, left 0.2s;
    }

    #character::before {
      content: '';
      display: block;
      width: 100%;
      height: 100%;
      background-image: url('images/nv1.png');
      background-size: cover;
      background-position: center;
    }

    #info-box {
      position: absolute;
      top: 10px;
      right: 10px;
      width: auto; /* T·ªëi ∆∞u cho di ƒë·ªông */
      background-color: var(--modal-bg);
      padding: 8px 12px;
      border-radius: 5px;
      font-size: clamp(0.8em, 3vw, 1em);
    }

    #clock, #money {
      display: flex;
      align-items: center;
    }

    #clock::before { content: '‚è∞'; margin-right: 5px; }
    #money::before { content: 'üí∞'; margin-right: 5px; }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      z-index: 20;
      text-align: center;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto; /* T·ªëi ∆∞u cho n·ªôi dung d√†i tr√™n di ƒë·ªông */
      width: 90vw; /* Chi·∫øm g·∫ßn h·∫øt m√†n h√¨nh di ƒë·ªông */
    }

    .modal button {
      margin: 5px;
      padding: 10px 20px; /* L·ªõn h∆°n cho touch */
      font-size: clamp(1em, 4vw, 1.2em);
      cursor: pointer;
      touch-action: manipulation;
    }

    #kitchen-error {
      color: red;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }

    #interaction {
      position: absolute;
      font-size: 1.5em; /* L·ªõn h∆°n cho touch */
      cursor: pointer;
      padding: 10px;
    }

    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url('images/splash.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      z-index: 100;
    }

    #splash-screen h1 {
      font-size: clamp(2em, 8vw, 4em);
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    #splash-screen p {
      font-size: clamp(1.2em, 5vw, 2em);
      margin: 10px;
      cursor: pointer;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    #splash-screen .credit {
      font-size: clamp(0.8em, 3vw, 1em);
      position: absolute;
      bottom: 10px;
      left: 10px;
      text-align: left;
    }

    #credit {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: clamp(0.6em, 2vw, 0.8em);
      color: black;
      z-index: 10;
    }

    .seed-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    #chief-praise .bubble {
      background-color: #f0f0f0;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
      position: relative;
    }

    #chief-praise .bubble::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      border: 10px solid transparent;
      border-top-color: #f0f0f0;
    }

    #chief-praise .chief-icon {
      width: 120px;
      height: 120px;
      margin-top: 20px;
      background-image: url('images/siquan.png');
      background-size: cover;
      background-position: center;
    }

    .modal .speech {
      width: 120px;
      height: 120px;
      margin: 10px auto;
      background-color: var(--primary-color);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
      background-size: cover;
      background-position: center;
    }

    #start-work-modal .speech {
      background-image: url('images/nv2.png');
    }

    #end-work-modal .speech, #end-game-modal .chief-speech {
      background-image: url('images/siquan.png');
    }

    #end-game-modal .character-speech {
      background-image: url('images/nv2.png');
    }

    #info-modal .speech {
      background-image: url('images/nv2.png');
    }

    #game-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: var(--overlay-bg);
      z-index: 15;
      display: none;
    }

    /* T·ªëi ∆∞u cho di ƒë·ªông v·ªõi media query */
    @media (max-width: 768px) {
      .cell {
        font-size: clamp(0.8em, 6vw, 1.5em);
      }

      #grid {
        grid-template-columns: repeat(10, minmax(0, 1fr));
      }

      .modal {
        width: 95vw;
        padding: 10px;
        font-size: 1.2em;
      }

      #info-box {
        top: 5px;
        right: 5px;
        font-size: 0.9em;
      }

      #interaction {
        font-size: 2em;
        padding: 15px;
      }
    }

    /* N√∫t ƒëi·ªÅu khi·ªÉn di chuy·ªÉn cho di ƒë·ªông */
    #controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: grid;
      grid-template-areas: 
        ". up ."
        "left . right"
        ". down .";
      grid-gap: 10px;
      z-index: 15;
    }

    #controls button {
      width: 50px;
      height: 50px;
      font-size: 1.5em;
      background-color: #ccc;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      touch-action: manipulation;
    }

    #up { grid-area: up; }
    #down { grid-area: down; }
    #left { grid-area: left; }
    #right { grid-area: right; }

    @media (min-width: 769px) {
      #controls { display: none; } /* ·∫®n n√∫t tr√™n desktop */
    }
  </style>
</head>
<body>

  <!-- Splash Screen -->
  <div id="splash-screen">
    <h1>TƒÉng Gia N√†o</h1>
    <p onclick="startGame()">B·∫•m ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
    <p onclick="loadGame()">T·∫£i game ƒë√£ l∆∞u</p>
    <p class="credit">*Game ƒë∆∞·ª£c l√†m b·ªüi Cao L·ªôc ti·ªÉu ƒë·ªôi c·ªëi 60mm v√† Grok AI</p>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <div id="grid"></div>
    <div id="character"></div>
    <div id="info-box">
      <span id="clock">16:00</span>
      <span id="money">500000 VNƒê</span>
    </div>
    <div id="interaction" onclick="handleInteraction()">üñêÔ∏è</div>
    <p id="credit">Game ƒë∆∞·ª£c l√†m b·ªüi Cao L·ªôc ti·ªÉu ƒë·ªôi c·ªëi 60mm v√† Grok AI</p>
  </div>

  <!-- N√∫t ƒëi·ªÅu khi·ªÉn di chuy·ªÉn cho di ƒë·ªông -->
  <div id="controls">
    <button id="up">‚Üë</button>
    <button id="down">‚Üì</button>
    <button id="left">‚Üê</button>
    <button id="right">‚Üí</button>
  </div>

  <!-- Modals -->
  <div id="profile-modal" class="modal">
    <h2>M·ªùi nh·∫≠p s∆° y·∫øu l√Ω l·ªãch</h2>
    <label for="name-input">T√™n:</label> <input type="text" id="name-input"><br><br>
    <label for="age-input">Tu·ªïi:</label> <input type="number" id="age-input"><br><br>
    <button onclick="submitProfile()">X√°c nh·∫≠n</button>
  </div>

  <div id="error-modal" class="modal">
    <p>B·∫°n kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán ƒëi nghƒ©a v·ª•, m·ªùi ki·ªÉm tra l·∫°i!</p>
    <button onclick="showProfileAgain()">Th·ª≠ l·∫°i</button>
  </div>

  <div id="unlock-modal" class="modal">
    <p>B·∫°n mu·ªën m·ªü kh√≥a √¥ n√†y? Gi√°: <span id="unlock-price"></span> VNƒê</p>
    <button onclick="confirmUnlock(true)">C√≥</button>
    <button onclick="confirmUnlock(false)">Kh√¥ng</button>
  </div>

  <div id="insufficient-modal" class="modal">
    <p>B·∫°n kh√¥ng ƒë·ªß ti·ªÅn!</p>
    <button onclick="closeModal('insufficient-modal')">OK</button>
  </div>

  <div id="shop-modal" class="modal">
    <h2>C·ª≠a h√†ng</h2>
    <div class="seed-item">
      <p>Gi·ªëng c·∫£i ng·ªçt: 1000 VNƒê</p>
      <button id="buy-cai-btn" onclick="showBuyOptions('cai')">Mua</button>
      <div id="buy-cai-options" style="display: none;">
        <button onclick="buyItem('cai', 1)">x1</button>
        <button onclick="buyItem('cai', 10)">x10</button>
        <button onclick="buyItem('cai', 100)">x100</button>
      </div>
    </div>
    <div class="seed-item">
      <p>Gi·ªëng m∆∞·ªõp: 1000 VNƒê</p>
      <button id="buy-muop-btn" onclick="showBuyOptions('muop')">Mua</button>
      <div id="buy-muop-options" style="display: none;">
        <button onclick="buyItem('muop', 1)">x1</button>
        <button onclick="buyItem('muop', 10)">x10</button>
        <button onclick="buyItem('muop', 100)">x100</button>
      </div>
    </div>
    <div class="seed-item">
      <p>Gi·ªëng ƒëu ƒë·ªß: 1000 VNƒê</p>
      <button id="buy-du_du-btn" onclick="showBuyOptions('du_du')">Mua</button>
      <div id="buy-du_du-options" style="display: none;">
        <button onclick="buyItem('du_du', 1)">x1</button>
        <button onclick="buyItem('du_du', 10)">x10</button>
        <button onclick="buyItem('du_du', 100)">x100</button>
      </div>
    </div>
    <div class="seed-item">
      <p>Bao ph√¢n b√≥n: 1000 VNƒê</p>
      <button id="buy-fertilizer-btn" onclick="showBuyOptions('fertilizer')">Mua</button>
      <div id="buy-fertilizer-options" style="display: none;">
        <button onclick="buyItem('fertilizer', 1)">x1</button>
        <button onclick="buyItem('fertilizer', 10)">x10</button>
        <button onclick="buyItem('fertilizer', 100)">x100</button>
      </div>
    </div>
    <button onclick="closeModal('shop-modal')">Tho√°t</button>
  </div>

  <div id="warehouse-modal" class="modal">
    <h2>Kho ƒë·∫°i ƒë·ªôi</h2>
    <p id="warehouse-content">Kho tr·ªëng</p>
    <button onclick="sellItem('cai', 1)" id="sell-cai-one-btn" style="display: none;">B√°n 1 c·∫£i (2000 VNƒê)</button>
    <button onclick="eatItem('cai')" id="eat-cai-btn" style="display: none;">ƒÇn c·∫£i</button>
    <button onclick="sellItem('cai', 'all')" id="sell-cai-all-btn" style="display: none;">B√°n t·∫•t c·∫£ c·∫£i</button>
    <button onclick="sellItem('muop', 1)" id="sell-muop-one-btn" style="display: none;">B√°n 1 m∆∞·ªõp (3000 VNƒê)</button>
    <button onclick="eatItem('muop')" id="eat-muop-btn" style="display: none;">ƒÇn m∆∞·ªõp</button>
    <button onclick="sellItem('muop', 'all')" id="sell-muop-all-btn" style="display: none;">B√°n t·∫•t c·∫£ m∆∞·ªõp</button>
    <button onclick="sellItem('du_du', 1)" id="sell-du_du-one-btn" style="display: none;">B√°n 1 ƒëu ƒë·ªß (5000 VNƒê)</button>
    <button onclick="eatItem('du_du')" id="eat-du_du-btn" style="display: none;">ƒÇn ƒëu ƒë·ªß</button>
    <button onclick="sellItem('du_du', 'all')" id="sell-du_du-all-btn" style="display: none;">B√°n t·∫•t c·∫£ ƒëu ƒë·ªß</button>
    <button onclick="sellItem('cai_luoc', 1)" id="sell-cai_luoc-one-btn" style="display: none;">B√°n 1 c·∫£i lu·ªôc (20000 VNƒê)</button>
    <button onclick="eatItem('cai_luoc')" id="eat-cai_luoc-btn" style="display: none;">ƒÇn c·∫£i lu·ªôc</button>
    <button onclick="sellItem('cai_luoc', 'all')" id="sell-cai_luoc-all-btn" style="display: none;">B√°n t·∫•t c·∫£ c·∫£i lu·ªôc</button>
    <button onclick="sellItem('canh_muop', 1)" id="sell-canh_muop-one-btn" style="display: none;">B√°n 1 canh m∆∞·ªõp (40000 VNƒê)</button>
    <button onclick="eatItem('canh_muop')" id="eat-canh_muop-btn" style="display: none;">ƒÇn canh m∆∞·ªõp</button>
    <button onclick="sellItem('canh_muop', 'all')" id="sell-canh_muop-all-btn" style="display: none;">B√°n t·∫•t c·∫£ canh m∆∞·ªõp</button>
    <button onclick="sellItem('du_du_xao', 1)" id="sell-du_du_xao-one-btn" style="display: none;">B√°n 1 ƒëu ƒë·ªß x√†o (30000 VNƒê)</button>
    <button onclick="eatItem('du_du_xao')" id="eat-du_du_xao-btn" style="display: none;">ƒÇn ƒëu ƒë·ªß x√†o</button>
    <button onclick="sellItem('du_du_xao', 'all')" id="sell-du_du_xao-all-btn" style="display: none;">B√°n t·∫•t c·∫£ ƒëu ƒë·ªß x√†o</button>
    <button onclick="closeModal('warehouse-modal')">Tho√°t</button>
  </div>

  <div id="task-modal" class="modal">
    <h2>Nhi·ªám v·ª• th·ªß tr∆∞·ªüng giao</h2>
    <p id="task-content"></p>
    <button id="deliver-task-btn" onclick="deliverTask()" style="display: none;">B√†n giao</button>
    <button onclick="closeModal('task-modal')">Tho√°t</button>
  </div>

  <div id="chief-praise" class="modal">
    <h2>Khen th∆∞·ªüng</h2>
    <p id="praise-message"></p>
    <div class="bubble">T·ªët l·∫Øm, ti·∫øp t·ª•c ph√°t huy!</div>
    <div class="chief-icon"></div>
    <button onclick="closeModal('chief-praise')">D·∫°</button>
  </div>

  <div id="kitchen-modal" class="modal">
    <h2>B·∫øp ƒÉn ƒë∆°n v·ªã</h2>
    <button onclick="cookDish('cai_luoc')">N·∫•u c·∫£i lu·ªôc (5 c·∫£i, 15 ph√∫t)</button>
    <button onclick="cookDish('canh_muop')">N·∫•u canh m∆∞·ªõp (5 m∆∞·ªõp, 30 ph√∫t)</button>
    <button onclick="cookDish('du_du_xao')">N·∫•u ƒëu ƒë·ªß x√†o (3 ƒëu ƒë·ªß, 15 ph√∫t)</button>
    <p id="kitchen-progress"></p>
    <p id="kitchen-error"></p>
    <button id="receive-dish-btn" onclick="receiveDish()" style="display: none;">Nh·∫≠n m√≥n</button>
    <button onclick="closeModal('kitchen-modal')">Tho√°t</button>
  </div>

  <div id="canteen-modal" class="modal">
    <h2>CƒÉn tin ƒë∆°n v·ªã</h2>
    <button id="buy-nuoc-ngot" onclick="buyCanteenItem('nuoc_ngot')">Mua n∆∞·ªõc ng·ªçt (12000 VNƒê, +20 th·ªÉ l·ª±c)</button>
    <button id="buy-banh-ngot" onclick="buyCanteenItem('banh_ngot')">Mua b√°nh ng·ªçt (15000 VNƒê, +30 th·ªÉ l·ª±c)</button>
    <button id="buy-my-goi" onclick="buyCanteenItem('my_goi')">Mua m√¨ g√≥i (20000 VNƒê, +50 th·ªÉ l·ª±c)</button>
    <button onclick="closeModal('canteen-modal')">Tho√°t</button>
  </div>

  <div id="plant-menu" class="modal">
    <h2>Menu Tr·ªìng</h2>
    <button id="plant-cai" onclick="plantSingle('cai')" style="display: none;">Tr·ªìng c·∫£i ng·ªçt</button>
    <button id="plant-muop" onclick="plantSingle('muop')" style="display: none;">Tr·ªìng m∆∞·ªõp</button>
    <button id="plant-du_du" onclick="plantSingle('du_du')" style="display: none;">Tr·ªìng ƒëu ƒë·ªß</button>
    <button id="quick-plant-btn" onclick="showQuickPlantMenu()" style="display: none;">Tr·ªìng nhanh t·∫•t c·∫£</button>
    <p id="no-seeds-msg" style="display: none;">B·∫°n kh√¥ng c√≥ gi·ªëng ƒë·ªÉ tr·ªìng</p>
    <button onclick="closeModal('plant-menu')">Tho√°t</button>
  </div>

  <div id="quick-plant-menu" class="modal">
    <h2>Tr·ªìng nhanh</h2>
    <button onclick="plantAll('cai')" id="quick-plant-cai" style="display: none;">Tr·ªìng c·∫£i ng·ªçt</button>
    <button onclick="plantAll('muop')" id="quick-plant-muop" style="display: none;">Tr·ªìng m∆∞·ªõp</button>
    <button onclick="plantAll('du_du')" id="quick-plant-du_du" style="display: none;">Tr·ªìng ƒëu ƒë·ªß</button>
    <button onclick="closeModal('quick-plant-menu')">Tho√°t</button>
  </div>

  <div id="harvest-menu" class="modal">
    <h2>Menu Thu Ho·∫°ch</h2>
    <button onclick="harvestSingle()">Thu ho·∫°ch</button>
    <button onclick="harvestAll()">Thu ho·∫°ch t·∫•t c·∫£</button>
    <button onclick="closeModal('harvest-menu')">Tho√°t</button>
  </div>

  <div id="weed-pest-menu" class="modal">
    <h2>X·ª≠ l√Ω c√¢y</h2>
    <button id="weed-single-btn" onclick="weedSingle()" style="display: none;">Nh·ªï c·ªè</button>
    <button id="pest-single-btn" onclick="pestSingle()" style="display: none;">B·∫Øt b·ªç</button>
    <button id="weed-all-btn" onclick="weedAll()" style="display: none;">Nh·ªï c·ªè nhanh</button>
    <button id="pest-all-btn" onclick="pestAll()" style="display: none;">B·∫Øt b·ªç nhanh</button>
    <button onclick="closeModal('weed-pest-menu')">Tho√°t</button>
  </div>

  <div id="water-menu" class="modal">
    <h2>T∆∞·ªõi n∆∞·ªõc</h2>
    <button onclick="waterSingle()">T∆∞·ªõi n∆∞·ªõc</button>
    <button onclick="waterAll()">T∆∞·ªõi nhanh t·∫•t c·∫£</button>
    <button onclick="closeModal('water-menu')">Tho√°t</button>
  </div>

  <div id="fertilize-menu" class="modal">
    <h2>B√≥n ph√¢n</h2>
    <button onclick="fertilizeSingle()">B√≥n ph√¢n</button>
    <button onclick="fertilizeAll()">B√≥n ph√¢n nhanh t·∫•t c·∫£</button>
    <button onclick="closeModal('fertilize-menu')">Tho√°t</button>
  </div>

  <div id="info-modal" class="modal">
    <h2>Th·∫ª qu√¢n nh√¢n</h2>
    <div id="player-icon" class="speech"></div>
    <p>T√™n: <span id="player-name"></span></p>
    <p>Tu·ªïi: <span id="player-age"></span></p>
    <p>C·∫•p b·∫≠c: <span id="player-rank"></span> <span id="rank-progress"></span></p>
    <p>Ng√†y nh·∫≠p ng≈©: <span id="start-date"></span></p>
    <p>ƒê·∫øm ng∆∞·ª£c xu·∫•t ng≈©: <span id="countdown"></span></p>
    <p>Th·ªÉ l·ª±c: <span id="stamina"></span>/100</p>
    <button onclick="saveGame()">L∆∞u Game</button>
    <button onclick="fastForwardDay()">Tua nhanh ng√†y</button>
    <button onclick="closeModal('info-modal')">Tho√°t</button>
  </div>

  <div id="start-day-modal" class="modal">
    <p id="start-day-message"></p>
  </div>

  <div id="start-work-modal" class="modal">
    <p id="start-work-message">TƒÉng gia th√¥i n√†o</p>
    <div class="speech"></div>
  </div>

  <div id="end-work-modal" class="modal">
    <p id="end-work-message">Th·ªß tr∆∞·ªüng: H√¥m nay t·ªõi ƒë√¢y th√¥i v·ªÅ n√†o c√°c em ∆°i</p>
    <div class="speech"></div>
  </div>

  <div id="end-game-modal" class="modal">
    <p id="end-game-message"></p>
    <div class="chief-speech speech"></div>
    <div class="character-speech speech"></div>
    <button onclick="restartGame()">Ch∆°i l·∫°i</button>
  </div>

  <div id="game-overlay"></div>

  <script>
    // Game Configuration
    const CONFIG = {
      GRID: { WIDTH: 10, HEIGHT: 10 },
      FARM: { START_COL: 4, TOTAL_CELLS: 60 },
      TIME: { DAY_DURATION: 5 * 60 * 1000, MINUTE_DURATION: (5 * 60 * 1000) / 90, START_HOUR: 16 * 60, END_HOUR: 17.5 * 60 }, // S·ª¨A: ƒê·ªïi th·ªùi gian ng√†y th√†nh 5 ph√∫t th·ª±c t·∫ø
      INITIAL: { MONEY: 500000, UNLOCKED_CELLS: 5, DAYS_LEFT: 730, STAMINA: 100 },
      COSTS: { SEEDS: 1000, LOCK_BASE: 100000, LOCK_INCREMENT: 50000 },
      PLANTS: {
        cai: { growthDays: 3, cost: 2000, emoji: 'ü•¨', maxHarvest: 1 },
        muop: { growthDays: 4, cost: 3000, emoji: 'ü•í', maxHarvest: 4 },
        du_du: { growthDays: 10, cost: 5000, emoji: 'üçà', maxHarvest: 4 }
      },
      DISHES: {
        cai_luoc: { veggies: 5, time: 15, cost: 20000 },
        canh_muop: { veggies: 5, time: 30, cost: 40000 },
        du_du_xao: { veggies: 3, time: 15, cost: 30000 }
      },
      RANKS: ['Binh nh√¨', 'Binh nh·∫•t', 'H·∫° sƒ©', 'Trung sƒ©', 'Th∆∞·ª£ng sƒ©'],
      TASK_COMPLETIONS: [0, 100, 200, 400, Infinity],
      EMOJIS: { seedling: 'üå±', weed: 'üåø', pest: 'üêû' },
      CANTEEN: {
        nuoc_ngot: { price: 12000, stamina: 20, dailyLimit: 3 },
        banh_ngot: { price: 15000, stamina: 30, dailyLimit: 1 },
        my_goi: { price: 20000, stamina: 50, dailyLimit: 1 }
      }
    };

    // Game State
    let state = {
      money: CONFIG.INITIAL.MONEY,
      seeds: { cai: 0, muop: 0, du_du: 0, fertilizer: 0 },
      veggies: { cai: 0, muop: 0, du_du: 0 },
      dishes: { cai_luoc: 0, canh_muop: 0, du_du_xao: 0 },
      cells: [],
      player: { row: 0, col: 1, name: '', age: 0, rank: CONFIG.RANKS[0], rankIndex: 0, completedTasks: 0, rankProgress: 0 },
      game: { daysLeft: CONFIG.INITIAL.DAYS_LEFT, time: CONFIG.TIME.START_HOUR, lastUpdate: null, initialized: false, paused: false, lastDayChecked: CONFIG.INITIAL.DAYS_LEFT, millionEarned: false, earlyEnd: false },
      task: null,
      cooking: [],
      stamina: CONFIG.INITIAL.STAMINA,
      dailyEats: { veggies: 0, dishes: 0 },
      dailyPurchases: { nuoc_ngot: 0, banh_ngot: 0, my_goi: 0 },
      unlockedCells: CONFIG.INITIAL.UNLOCKED_CELLS,
      currentUnlockIndex: null
    };

    const LOCATIONS = {
      shop: { row: 0, col: 0, emoji: 'üè™', modal: 'shop-modal' },
      warehouse: { row: 2, col: 0, emoji: 'üè†', modal: 'warehouse-modal' },
      task: { row: 4, col: 0, emoji: 'üìã', modal: 'task-modal' },
      kitchen: { row: 6, col: 0, emoji: 'üçΩÔ∏è', modal: 'kitchen-modal' },
      canteen: { row: 8, col: 0, emoji: 'üç¥', modal: 'canteen-modal' }
    };

    // DOM Utilities
    const $ = (id) => document.getElementById(id);
    const showModal = (id) => { $(id).style.display = 'block'; state.game.paused = true; $('interaction').style.display = 'none'; };
    const closeModal = (id) => {
      $(id).style.display = 'none';
      state.game.paused = false;
      if (id === 'shop-modal') {
        ['cai', 'muop', 'du_du', 'fertilizer'].forEach(type => {
          $(`buy-${type}-options`).style.display = 'none';
          $(`buy-${type}-btn`).style.display = 'inline';
        });
      }
      if (id === 'kitchen-modal') {
        clearKitchenError();
      }
      $('interaction').style.display = 'block';
    };

    function showKitchenError(message) {
      const error = $('kitchen-error');
      error.innerText = message;
      error.style.display = 'block';
      setTimeout(clearKitchenError, 3000);
    }

    function clearKitchenError() {
      const error = $('kitchen-error');
      error.innerText = '';
      error.style.display = 'none';
    }

    // Initialize Game
    function initGrid() {
      const grid = $('grid');
      if (!state.cells.length) {
        state.cells = Array(CONFIG.GRID.HEIGHT).fill().map(() => Array(CONFIG.GRID.WIDTH).fill(null));
      }

      grid.innerHTML = '';
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = 0; col < CONFIG.GRID.WIDTH; col++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');
          cell.dataset.row = row;
          cell.dataset.col = col;

          if (col >= CONFIG.FARM.START_COL) {
            const farmIndex = (row * (CONFIG.GRID.WIDTH - CONFIG.FARM.START_COL)) + (col - CONFIG.FARM.START_COL);
            if (!state.cells[row][col] || state.cells[row][col].type === 'locked') {
              state.cells[row][col] = farmIndex < state.unlockedCells
                ? { type: 'plantable', planted: false, plantType: null, plantDay: null, ripe: false, weed: false, pest: false, affectedDay: null, watered: false, fertilized: false, harvestCount: 0 }
                : { type: 'locked' };
            }
            cell.classList.add(state.cells[row][col].type);
            if (state.cells[row][col].planted) {
              cell.innerText = state.cells[row][col].weed ? CONFIG.EMOJIS.weed :
                               state.cells[row][col].pest ? CONFIG.EMOJIS.pest :
                               state.cells[row][col].ripe ? CONFIG.PLANTS[state.cells[row][col].plantType].emoji :
                               CONFIG.EMOJIS.seedling;
            }
          } else {
            cell.classList.add('grass');
            state.cells[row][col] = state.cells[row][col] || { type: 'grass' };
            Object.values(LOCATIONS).forEach(loc => {
              if (row === loc.row && col === loc.col) cell.innerText = loc.emoji;
            });
          }
          grid.appendChild(cell);
        }
      }
      state.game.initialized = true;
      updatePlayerPosition();
      updateClock();
    }

    // Start Game
    function startGame() {
      $('splash-screen').style.display = 'none';
      showModal('profile-modal');
    }

    // Load Game
    function loadGame() {
      const saved = JSON.parse(localStorage.getItem('tangGiaNao'));
      if (saved) {
        Object.assign(state, saved);
        state.game.lastUpdate = Date.now();
        state.game.startDate = new Date(saved.startDate);
        state.dailyPurchases = { nuoc_ngot: 0, banh_ngot: 0, my_goi: 0 }; // S·ª¨A: Reset dailyPurchases khi load ƒë·ªÉ tr√°nh bug modal cƒÉn tin kh√¥ng ho·∫°t ƒë·ªông n·∫øu save c≈© c√≥ mua h√†ng
        state.dailyEats = { veggies: 0, dishes: 0 }; // S·ª¨A: Reset dailyEats t∆∞∆°ng t·ª±
        $('splash-screen').style.display = 'none';
        $('game-container').style.display = 'block';
        initGrid();
        updateMoney();
        updateTask();
        updatePlants();
        updateInfo();
        updateCanteen();
      } else {
        alert('Kh√¥ng t√¨m th·∫•y game ƒë√£ l∆∞u!');
      }
    }

    // Save Game
    function saveGame() {
      if (!state.game.initialized) return alert('Game ch∆∞a kh·ªüi t·∫°o!');
      try {
        localStorage.setItem('tangGiaNao', JSON.stringify({ ...state, startDate: state.game.startDate?.toISOString() }));
        alert('Game ƒë√£ ƒë∆∞·ª£c l∆∞u!');
      } catch {
        alert('L∆∞u game th·∫•t b·∫°i!');
      }
    }

    // Profile Submission
    function submitProfile() {
      const name = $('name-input').value.trim();
      const age = parseInt($('age-input').value);
      if (name && age >= 18 && age <= 27) {
        state.player.name = name;
        state.player.age = age;
        state.game.startDate = new Date();
        state.game.lastUpdate = Date.now();
        closeModal('profile-modal');
        $('start-day-message').innerText = `Ng√†y th·ª© ${state.game.daysLeft} nh·∫≠p ng≈©`;
        showModal('start-day-modal');
        setTimeout(() => {
          closeModal('start-day-modal');
          $('start-work-message').innerText = 'TƒÉng gia th√¥i n√†o';
          showModal('start-work-modal');
          setTimeout(() => {
            closeModal('start-work-modal');
            $('game-container').style.display = 'block';
            initGrid();
            updateMoney();
            generateDailyTask();
            updatePlants();
            updateCanteen();
          }, 2000);
        }, 2000);
      } else {
        showModal('error-modal');
      }
    }

    function showProfileAgain() {
      closeModal('error-modal');
      showModal('profile-modal');
      $('name-input').value = '';
      $('age-input').value = '';
    }

    // Player Movement
    function updatePlayerPosition() {
      if (!state.game.initialized) return;
      const char = $('character');
      const grid = $('grid');
      const cellWidth = grid.offsetWidth / CONFIG.GRID.WIDTH;
      const cellHeight = grid.offsetHeight / CONFIG.GRID.HEIGHT;
      char.style.left = `${state.player.col * cellWidth}px`;
      char.style.top = `${state.player.row * cellHeight}px`;
      const interaction = $('interaction');
      interaction.style.left = `${(state.player.col + 1) * cellWidth - interaction.offsetWidth - 5}px`;
      interaction.style.top = `${state.player.row * cellHeight + 5}px`;
      state.currentCell = state.cells[state.player.row]?.[state.player.col];
      updateInteraction();
      checkAutoModals();
    }

    document.addEventListener('keydown', (e) => {
      if (!state.game.initialized) return;
      let { row, col } = state.player;
      if (e.key === 'ArrowUp' && row > 0) row--;
      if (e.key === 'ArrowDown' && row < CONFIG.GRID.HEIGHT - 1) row++;
      if (e.key === 'ArrowLeft' && col > 0) col--;
      if (e.key === 'ArrowRight' && col < CONFIG.GRID.WIDTH - 1) col++;
      if (row !== state.player.row || col !== state.player.col) {
        state.player.row = row;
        state.player.col = col;
        updatePlayerPosition();
      }
    });

    // Th√™m x·ª≠ l√Ω cho n√∫t di chuy·ªÉn di ƒë·ªông
    function movePlayer(direction) {
      if (!state.game.initialized) return;
      let { row, col } = state.player;
      if (direction === 'up' && row > 0) row--;
      if (direction === 'down' && row < CONFIG.GRID.HEIGHT - 1) row++;
      if (direction === 'left' && col > 0) col--;
      if (direction === 'right' && col < CONFIG.GRID.WIDTH - 1) col++;
      if (row !== state.player.row || col !== state.player.col) {
        state.player.row = row;
        state.player.col = col;
        updatePlayerPosition();
      }
    }

    $('up').addEventListener('click', () => movePlayer('up'));
    $('down').addEventListener('click', () => movePlayer('down'));
    $('left').addEventListener('click', () => movePlayer('left'));
    $('right').addEventListener('click', () => movePlayer('right'));

    // Money Management
    function updateMoney() {
      $('money').innerText = `${state.money} VNƒê`;
      checkMillionEarned();
      checkGameOver();
    }

    // Shop and Inventory
    function showBuyOptions(type) {
      $(`buy-${type}-options`).style.display = 'inline';
      $(`buy-${type}-btn`).style.display = 'none';
    }

    function buyItem(type, amount) {
      const cost = CONFIG.COSTS.SEEDS * amount;
      if (state.money >= cost) {
        state.money -= cost;
        state.seeds[type] += amount;
        updateMoney();
        closeModal('shop-modal');
      } else {
        showModal('insufficient-modal');
      }
    }

    function sellItem(type, amount) {
      const isDish = ['cai_luoc', 'canh_muop', 'du_du_xao'].includes(type);
      const inventory = isDish ? state.dishes : state.veggies;
      const cost = isDish ? CONFIG.DISHES[type].cost : CONFIG.PLANTS[type].cost;
      let sellAmount = amount === 'all' ? inventory[type] : 1;
      if (sellAmount > inventory[type]) sellAmount = inventory[type];
      if (sellAmount > 0) {
        state.money += cost * sellAmount;
        inventory[type] -= sellAmount;
        updateMoney();
        updateWarehouse();
        checkTaskProgress();
      }
    }

    function eatItem(type) {
      const isDish = ['cai_luoc', 'canh_muop', 'du_du_xao'].includes(type);
      const inventory = isDish ? state.dishes : state.veggies;
      const maxEats = isDish ? 1 : 2;
      const eats = isDish ? state.dailyEats.dishes : state.dailyEats.veggies;
      const staminaGain = isDish ? 10 : 5;
      if (inventory[type] > 0 && eats < maxEats) {
        inventory[type]--;
        state.stamina = Math.min(100, state.stamina + staminaGain);
        if (isDish) state.dailyEats.dishes++; else state.dailyEats.veggies++;
        updateWarehouse();
      } else {
      }
    }

    function getItemName(type) {
      return {
        cai: 'c·∫£i ng·ªçt', muop: 'm∆∞·ªõp', du_du: 'ƒëu ƒë·ªß',
        cai_luoc: 'c·∫£i lu·ªôc', canh_muop: 'canh m∆∞·ªõp', du_du_xao: 'ƒëu ƒë·ªß x√†o'
      }[type];
    }

    // Canteen Functions
    function buyCanteenItem(type) {
      const item = CONFIG.CANTEEN[type];
      if (state.dailyPurchases[type] >= item.dailyLimit) {
        return;
      }
      if (state.money < item.price) {
        return showModal('insufficient-modal');
      }
      state.money -= item.price;
      state.stamina = Math.min(100, state.stamina + item.stamina);
      state.dailyPurchases[type]++;
      updateMoney();
      updateCanteen();
    }

    function getCanteenItemName(type) {
      return {
        nuoc_ngot: 'n∆∞·ªõc ng·ªçt',
        banh_ngot: 'b√°nh ng·ªçt',
        my_goi: 'm√¨ g√≥i'
      }[type];
    }

    function updateCanteen() {
      $('buy-nuoc-ngot').disabled = state.dailyPurchases.nuoc_ngot >= CONFIG.CANTEEN.nuoc_ngot.dailyLimit;
      $('buy-banh-ngot').disabled = state.dailyPurchases.banh_ngot >= CONFIG.CANTEEN.banh_ngot.dailyLimit;
      $('buy-my-goi').disabled = state.dailyPurchases.my_goi >= CONFIG.CANTEEN.my_goi.dailyLimit;
    }

    // Farming Actions
    function plantSingle(type) {
      closeModal('plant-menu');
      if (state.stamina < 2) return;
      if (state.seeds[type] > 0 && state.currentCell && !state.currentCell.planted) {
        state.seeds[type]--;
        Object.assign(state.currentCell, {
          planted: true, plantType: type, plantDay: state.game.daysLeft, watered: false,
          fertilized: false, weed: false, pest: false, affectedDay: null, harvestCount: 0
        });
        updateCell(state.player.row, state.player.col, CONFIG.EMOJIS.seedling);
        state.stamina -= 2;
        if (state.stamina <= 0) endDayEarly();
      }
    }

    function plantAll(type) {
      closeModal('quick-plant-menu');
      if (state.stamina < 2) return;
      let count = 0;
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          if (state.cells[row][col]?.type === 'plantable' && !state.cells[row][col].planted && state.seeds[type] > 0) {
            state.seeds[type]--;
            Object.assign(state.cells[row][col], {
              planted: true, plantType: type, plantDay: state.game.daysLeft, watered: false,
              fertilized: false, weed: false, pest: false, affectedDay: null, harvestCount: 0
            });
            updateCell(row, col, CONFIG.EMOJIS.seedling);
            count++;
            state.stamina -= 2;
            if (state.stamina <= 0) return endDayEarly();
          }
        }
      }
    }

    function harvestSingle() {
      closeModal('harvest-menu');
      if (state.stamina < 2) return;
      if (state.currentCell?.ripe) {
        const { plantType } = state.currentCell;
        const amount = plantType === 'cai' ? 1 : Math.floor(Math.random() * 3) + 1;
        state.veggies[plantType] += amount;
        state.currentCell.ripe = false;
        state.currentCell.harvestCount++;
        if (plantType === 'cai' || state.currentCell.harvestCount >= CONFIG.PLANTS[plantType].maxHarvest) {
          resetCell(state.currentCell);
          updateCell(state.player.row, state.player.col, '');
        }
        checkTaskProgress();
        state.stamina -= 2;
        if (state.stamina <= 0) endDayEarly();
      }
    }

    function harvestAll() {
      closeModal('harvest-menu');
      if (state.stamina < 2) return;
      let count = 0;
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          if (state.cells[row][col]?.ripe) {
            const { plantType } = state.cells[row][col];
            const amount = plantType === 'cai' ? 1 : Math.floor(Math.random() * 3) + 1;
            state.veggies[plantType] += amount;
            state.cells[row][col].ripe = false;
            state.cells[row][col].harvestCount++;
            if (plantType === 'cai' || state.cells[row][col].harvestCount >= CONFIG.PLANTS[plantType].maxHarvest) {
              resetCell(state.cells[row][col]);
              updateCell(row, col, '');
            }
            count++;
            state.stamina -= 2;
            if (state.stamina <= 0) return endDayEarly();
          }
        }
      }
      checkTaskProgress();
    }

    function weedSingle() {
      closeModal('weed-pest-menu');
      if (state.stamina < 2) return;
      if (state.currentCell?.weed) {
        state.currentCell.weed = false;
        state.currentCell.affectedDay = null;
        updateCell(state.player.row, state.player.col, state.currentCell.ripe ? CONFIG.PLANTS[state.currentCell.plantType].emoji : CONFIG.EMOJIS.seedling);
        state.stamina -= 2;
        if (state.stamina <= 0) endDayEarly();
      }
    }

    function pestSingle() {
      closeModal('weed-pest-menu');
      if (state.stamina < 2) return;
      if (state.currentCell?.pest) {
        state.currentCell.pest = false;
        state.currentCell.affectedDay = null;
        updateCell(state.player.row, state.player.col, state.currentCell.ripe ? CONFIG.PLANTS[state.currentCell.plantType].emoji : CONFIG.EMOJIS.seedling);
        state.stamina -= 2;
        if (state.stamina <= 0) endDayEarly();
      }
    }

    function weedAll() {
      closeModal('weed-pest-menu');
      if (state.stamina < 2) return;
      let count = 0;
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          if (state.cells[row][col]?.weed) {
            state.cells[row][col].weed = false;
            state.cells[row][col].affectedDay = null;
            updateCell(row, col, state.cells[row][col].ripe ? CONFIG.PLANTS[state.cells[row][col].plantType].emoji : CONFIG.EMOJIS.seedling);
            count++;
            state.stamina -= 2;
            if (state.stamina <= 0) return endDayEarly();
          }
        }
      }
    }

    function pestAll() {
      closeModal('weed-pest-menu');
      if (state.stamina < 2) return;
      let count = 0;
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          if (state.cells[row][col]?.pest) {
            state.cells[row][col].pest = false;
            state.cells[row][col].affectedDay = null;
            updateCell(row, col, state.cells[row][col].ripe ? CONFIG.PLANTS[state.cells[row][col].plantType].emoji : CONFIG.EMOJIS.seedling);
            count++;
            state.stamina -= 2;
            if (state.stamina <= 0) return endDayEarly();
          }
        }
      }
    }

    function waterSingle() {
      closeModal('water-menu');
      if (state.stamina < 2) return;
      if (state.currentCell && !state.currentCell.watered) {
        state.currentCell.watered = true;
        state.stamina -= 2;
        if (state.stamina <= 0) endDayEarly();
      }
    }

    function waterAll() {
      closeModal('water-menu');
      if (state.stamina < 2) return;
      let count = 0;
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          if (state.cells[row][col]?.planted && !state.cells[row][col].watered) {
            state.cells[row][col].watered = true;
            count++;
            state.stamina -= 2;
            if (state.stamina <= 0) return endDayEarly();
          }
        }
      }
    }

    function fertilizeSingle() {
      closeModal('fertilize-menu');
      if (state.stamina < 2) return;
      if (state.currentCell && !state.currentCell.fertilized && state.seeds.fertilizer > 0) {
        state.seeds.fertilizer--;
        state.currentCell.fertilized = true;
        state.stamina -= 2;
        if (state.stamina <= 0) endDayEarly();
      }
    }

    function fertilizeAll() {
      closeModal('fertilize-menu');
      if (state.stamina < 2) return;
      let count = 0;
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          if (state.cells[row][col]?.planted && !state.cells[row][col].fertilized && state.seeds.fertilizer > 0) {
            state.seeds.fertilizer--;
            state.cells[row][col].fertilized = true;
            count++;
            state.stamina -= 2;
            if (state.stamina <= 0) return endDayEarly();
          }
        }
      }
    }

    // Cooking
    function cookDish(type) {
      clearKitchenError();
      if (state.stamina < 3) {
        showKitchenError('Th·ªÉ l·ª±c kh√¥ng ƒë·ªß!');
        return;
      }
      const veggieType = type === 'cai_luoc' ? 'cai' : type === 'canh_muop' ? 'muop' : 'du_du';
      const required = CONFIG.DISHES[type].veggies;
      if (state.veggies[veggieType] >= required) {
        if (state.cooking.some(c => c.type === type && state.game.time < c.startTime + CONFIG.DISHES[c.type].time)) {
          showKitchenError('M√≥n n√†y ƒëang ƒë∆∞·ª£c n·∫•u!');
          return;
        }
        state.veggies[veggieType] -= required;
        state.cooking.push({ type, startTime: state.game.time });
        state.stamina -= 3;
        updateWarehouse();
        updateKitchen();
        if (state.stamina <= 0) endDayEarly();
      } else {
        showKitchenError('B·∫°n kh√¥ng c√≥ ƒë·ªß nguy√™n li·ªáu!');
      }
    }

    function receiveDish() {
      clearKitchenError();
      state.cooking = state.cooking.filter(c => {
        if (state.game.time >= c.startTime + CONFIG.DISHES[c.type].time) {
          state.dishes[c.type]++;
          return false;
        }
        return true;
      });
      updateKitchen();
      updateWarehouse();
      checkTaskProgress();
    }

    function updateKitchen() {
      clearKitchenError();
      const progress = $('kitchen-progress');
      const receiveBtn = $('receive-dish-btn');
      if (state.cooking.length === 0) {
        progress.innerText = '';
        receiveBtn.style.display = 'none';
      } else {
        progress.innerText = state.cooking.map(c => `ƒêang n·∫•u ${getItemName(c.type)}.`).join('\n');
        receiveBtn.style.display = state.cooking.some(c => state.game.time >= c.startTime + CONFIG.DISHES[c.type].time) ? 'inline' : 'none';
      }
    }

    // Task Management
    function generateDailyTask() {
      const produceType = Object.keys(CONFIG.PLANTS)[Math.floor(Math.random() * 3)];
      const dishType = Object.keys(CONFIG.DISHES)[Math.floor(Math.random() * 3)];
      state.task = {
        produce: { type: produceType, goal: 1, completed: false },
        dish: { type: dishType, goal: 1, completed: false },
        delivered: false
      };
      state.taskCompleted = false;
      updateTask();
    }

    function updateTask() {
      const content = $('task-content');
      const deliverBtn = $('deliver-task-btn');
      if (state.taskCompleted) {
        content.innerText = 'B·∫°n ƒë√£ ho√†n th√†nh nhi·ªám v·ª• h√¥m nay!';
        deliverBtn.style.display = 'none';
      } else {
        content.innerText = [
          `Nhi·ªám v·ª• 1: Thu ho·∫°ch ${state.task.produce.goal} ${getItemName(state.task.produce.type)}${state.task.produce.completed ? ' (Ho√†n th√†nh)' : ''}`,
          `Nhi·ªám v·ª• 2: N·∫•u ${state.task.dish.goal} ${getItemName(state.task.dish.type)}${state.task.dish.completed ? ' (Ho√†n th√†nh)' : ''}`
        ].join('\n');
        deliverBtn.style.display = state.task.produce.completed && state.task.dish.completed ? 'inline' : 'none';
      }
    }

    function deliverTask() {
      if (state.task.produce.completed && state.task.dish.completed && !state.task.delivered) {
        state.task.delivered = true;
        state.taskCompleted = true;
        const reward = state.task.produce.goal * CONFIG.PLANTS[state.task.produce.type].cost * 2 +
                       state.task.dish.goal * CONFIG.DISHES[state.task.dish.type].cost * 2;
        state.money += reward;
        updateMoney();
        $('praise-message').innerText = `Th∆∞·ªüng: ${reward} VNƒê`;
        showModal('chief-praise');
        closeModal('task-modal');
        state.player.completedTasks++;
        checkRank();
        updateInfo();
      }
    }

    function checkTaskProgress() {
      if (!state.taskCompleted) {
        if (!state.task.produce.completed && state.veggies[state.task.produce.type] >= state.task.produce.goal) {
          state.task.produce.completed = true;
        }
        if (!state.task.dish.completed && state.dishes[state.task.dish.type] >= state.task.dish.goal) {
          state.task.dish.completed = true;
        }
        updateTask();
      }
    }

    // Plant Management
    function updatePlants() {
      const plantedCells = [];
      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          if (state.cells[row][col]?.type === 'plantable' && state.cells[row][col].planted) {
            plantedCells.push({ row, col });
          }
        }
      }

      if (state.game.lastDayChecked !== state.game.daysLeft) {
        state.game.lastDayChecked = state.game.daysLeft;
        const maxAffected = Math.floor(plantedCells.length * 0.3);
        let affectedCount = 0;
        plantedCells.forEach(({ row, col }) => {
          const cell = state.cells[row][col];
          if (cell.planted && !cell.ripe && !cell.weed && !cell.pest && cell.plantDay !== null) {
            const daysSincePlanted = cell.plantDay - state.game.daysLeft;
            const growthDays = CONFIG.PLANTS[cell.plantType].growthDays;
            if (daysSincePlanted >= 1 && daysSincePlanted < growthDays && affectedCount < maxAffected) {
              let prob = 0.3;
              if (cell.watered) prob *= 0.85;
              if (cell.fertilized) prob *= 0.85;
              if (Math.random() < prob) {
                const isWeed = Math.random() < 0.5;
                cell[isWeed ? 'weed' : 'pest'] = true;
                cell.affectedDay = state.game.daysLeft;
                updateCell(row, col, isWeed ? CONFIG.EMOJIS.weed : CONFIG.EMOJIS.pest);
                affectedCount++;
              }
            }
          }
        });
      }

      // S·ª¨A: Di chuy·ªÉn check ch·∫øt c√¢y ra loop ri√™ng ƒë·ªÉ ki·ªÉm tra m·ªçi l√∫c, ƒë·∫£m b·∫£o ch·ª©c nƒÉng ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh h∆°n (kh√¥ng ph·ª• thu·ªôc ch·ªâ v√†o thay ƒë·ªïi ng√†y)
      plantedCells.forEach(({ row, col }) => {
        const cell = state.cells[row][col];
        if ((cell.weed || cell.pest) && cell.affectedDay !== null && state.game.daysLeft <= cell.affectedDay - 1) {
          resetCell(cell);
          updateCell(row, col, '');
        }
      });

      for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
        for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
          const cell = state.cells[row][col];
          if (cell?.type === 'plantable' && cell.planted && !cell.ripe && cell.plantDay !== null) {
            const daysSincePlanted = cell.plantDay - state.game.daysLeft;
            const growthDays = CONFIG.PLANTS[cell.plantType].growthDays;
            if (state.game.daysLeft <= cell.plantDay - growthDays) {
              cell.ripe = true;
              cell.weed = false;
              cell.pest = false;
              cell.affectedDay = null;
              updateCell(row, col, CONFIG.PLANTS[cell.plantType].emoji);
            }
          } else if (cell?.ripe && cell.plantDay !== null && state.game.daysLeft <= cell.plantDay - CONFIG.PLANTS[cell.plantType].growthDays - 1) {
            resetCell(cell);
            updateCell(row, col, '');
          }
        }
      }

      if (state.game.lastDayChecked !== state.game.daysLeft) {
        for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
          for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
            const cell = state.cells[row][col];
            if (cell?.planted && !cell.ripe && ['muop', 'du_du'].includes(cell.plantType) && cell.harvestCount < CONFIG.PLANTS[cell.plantType].maxHarvest) {
              cell.ripe = true;
              updateCell(row, col, CONFIG.PLANTS[cell.plantType].emoji);
            }
          }
        }
      }
    }

    function resetCell(cell) {
      Object.assign(cell, {
        planted: false, plantType: null, plantDay: null, ripe: false,
        watered: false, fertilized: false, weed: false, pest: false, affectedDay: null, harvestCount: 0
      });
    }

    function updateCell(row, col, content) {
      const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
      if (cell) cell.innerText = content;
    }

    // Game Progression
    function checkGameOver() {
      const hasPlants = state.cells.some(row => row.some(cell => cell?.planted));
      const hasInventory = Object.values(state.veggies).some(v => v > 0) || Object.values(state.dishes).some(d => d > 0);
      if (state.money <= 0 && !hasPlants && !hasInventory) {
        $('game-container').style.display = 'none';
        $('end-game-message').innerText = `Ch·∫•t l∆∞·ª£ng tƒÉng gia c·ªßa ƒë·ªìng ch√≠ qu√° k√©m, b·∫°n s·∫Ω kh√¥ng ƒë∆∞·ª£c c·∫Øt l√†m c√¥ng t√°c tƒÉng gia n√†y n·ªØa`;
        showModal('end-game-modal');
        state.game.initialized = false;
      }
    }

    function checkMillionEarned() {
      if (state.money >= 100000000 && !state.game.millionEarned) {
        state.game.millionEarned = true;
        state.player.rankIndex = CONFIG.RANKS.indexOf('Th∆∞·ª£ng sƒ©');
        state.player.rank = 'Th∆∞·ª£ng sƒ©';
        state.player.completedTasks = 0;
      }
    }

    function checkRank() {
      if (state.player.rankIndex === 0 && state.game.daysLeft <= CONFIG.INITIAL.DAYS_LEFT - 640) {
        state.player.rankIndex = 1;
        state.player.rank = CONFIG.RANKS[1];
      } else if (state.player.rankIndex < CONFIG.RANKS.length - 1 && state.player.completedTasks >= CONFIG.TASK_COMPLETIONS[state.player.rankIndex]) {
        state.player.rankIndex++;
        state.player.rank = CONFIG.RANKS[state.player.rankIndex];
      }
    }

    function endDayEarly() {
      state.game.earlyEnd = true;
      endDay();
    }

    function endDay() {
      $('game-overlay').style.display = 'block';
      showModal('end-work-modal');
      setTimeout(() => {
        closeModal('end-work-modal');
        $('game-overlay').style.display = 'none';
        // Ho√†n th√†nh t·∫•t c·∫£ m√≥n ƒÉn ƒëang n·∫•u khi tua ng√†y
        state.cooking.forEach(c => {
          state.dishes[c.type]++;
        });
        state.cooking = [];
        updateKitchen();
        updateWarehouse();
        checkTaskProgress();
        state.game.daysLeft--;
        state.game.time = CONFIG.TIME.START_HOUR;
        if (state.game.earlyEnd) {
          state.stamina = 10;
          state.game.earlyEnd = false;
        } else {
          state.stamina = Math.min(100, state.stamina + 20);
        }
        state.dailyEats.veggies = 0;
        state.dailyEats.dishes = 0;
        state.dailyPurchases = { nuoc_ngot: 0, banh_ngot: 0, my_goi: 0 };
        updateClock();
        generateDailyTask();
        updatePlants();
        updateKitchen();
        updateCanteen();
        checkRank();
        updateInfo();
        checkGameOver();
        if (state.game.daysLeft <= 0) {
          $('game-container').style.display = 'none';
          $('end-game-message').innerText = `Ch√∫c m·ª´ng ƒë·ªìng ch√≠ ${state.player.rank} ${state.player.name} ƒë√£ ho√†n th√†nh nghƒ©a v·ª• qu√¢n s·ª±, ch√∫c b·∫°n may m·∫Øn khi tr·ªü v·ªÅ v·ªõi gia ƒë√¨nh!`;
          showModal('end-game-modal');
          state.game.initialized = false;
        } else {
          $('start-day-message').innerText = `Ng√†y th·ª© ${state.game.daysLeft} nh·∫≠p ng≈©`;
          showModal('start-day-modal');
          setTimeout(() => {
            closeModal('start-day-modal');
            $('start-work-message').innerText = 'TƒÉng gia th√¥i n√†o';
            showModal('start-work-modal');
            setTimeout(() => closeModal('start-work-modal'), 2000);
          }, 2000);
        }
      }, 2000);
    }

    function fastForwardDay() {
      closeModal('info-modal');
      endDay();
    }

    // Game Loop
    setInterval(() => {
      if (!state.game.initialized || !state.game.lastUpdate || state.game.paused) return;
      const now = Date.now();
      state.game.time += (now - state.game.lastUpdate) / CONFIG.TIME.MINUTE_DURATION;
      state.game.lastUpdate = now;
      updateClock();
      if (state.game.time >= CONFIG.TIME.END_HOUR) endDay();
      updatePlants();
      updateKitchen();
    }, 1000);

    function updateClock() {
      const hours = Math.floor(state.game.time / 60);
      const minutes = Math.floor(state.game.time % 60);
      $('clock').innerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    // Interaction
    function updateInteraction() {
      const icon = $('interaction');
      if (!state.currentCell) return;
      if (state.currentCell.type === 'grass') {
        const loc = Object.values(LOCATIONS).find(l => state.player.row === l.row && state.player.col === l.col);
        icon.innerText = loc ? loc.emoji : 'ü™™';
      } else {
        icon.innerText = 'üñêÔ∏è';
      }
    }

    function handleInteraction() {
      if (!state.currentCell || !state.game.initialized) return;
      state.game.paused = true;
      if (state.currentCell.type === 'locked') {
        state.currentUnlockIndex = state.unlockedCells - CONFIG.INITIAL.UNLOCKED_CELLS;
        const cost = CONFIG.COSTS.LOCK_BASE + state.currentUnlockIndex * CONFIG.COSTS.LOCK_INCREMENT;
        $('unlock-price').innerText = cost;
        showModal('unlock-modal');
      } else if (state.currentCell.type === 'plantable') {
        if (state.currentCell.planted) {
          if (state.currentCell.ripe) {
            showModal('harvest-menu');
          } else if (state.currentCell.weed || state.currentCell.pest) {
            $('weed-single-btn').style.display = state.currentCell.weed ? 'inline' : 'none';
            $('pest-single-btn').style.display = state.currentCell.pest ? 'inline' : 'none';
            $('weed-all-btn').style.display = state.cells.some(row => row.some(cell => cell?.weed)) ? 'inline' : 'none';
            $('pest-all-btn').style.display = state.cells.some(row => row.some(cell => cell?.pest)) ? 'inline' : 'none';
            showModal('weed-pest-menu');
          } else {
            const daysSincePlanted = state.currentCell.plantDay - state.game.daysLeft;
            if (daysSincePlanted === 0 && !state.currentCell.watered) {
              showModal('water-menu');
            } else if (daysSincePlanted === 1 && !state.currentCell.fertilized) {
              showModal('fertilize-menu');
            } else {
              showPlantMenu();
            }
          }
        } else {
          showPlantMenu();
        }
      } else {
        const loc = Object.values(LOCATIONS).find(l => state.player.row === l.row && state.player.col === l.col);
        if (loc) {
          if (loc.modal === 'warehouse-modal') updateWarehouse();
          if (loc.modal === 'task-modal') updateTask();
          if (loc.modal === 'kitchen-modal') updateKitchen();
          if (loc.modal === 'canteen-modal') updateCanteen();
          showModal(loc.modal);
        } else {
          updateInfo();
          showModal('info-modal');
        }
      }
    }

    function checkAutoModals() {
      const modals = ['shop-modal', 'warehouse-modal', 'task-modal', 'kitchen-modal', 'canteen-modal', 'info-modal', 'plant-menu', 'harvest-menu', 'weed-pest-menu', 'quick-plant-menu', 'unlock-modal', 'insufficient-modal', 'chief-praise', 'water-menu', 'fertilize-menu'];
      modals.forEach(closeModal);
      if (state.currentCell?.type === 'grass') {
        const loc = Object.values(LOCATIONS).find(l => state.player.row === l.row && state.player.col === l.col);
        if (loc) {
          if (loc.modal === 'warehouse-modal') updateWarehouse();
          if (loc.modal === 'task-modal') updateTask();
          if (loc.modal === 'kitchen-modal') updateKitchen();
          if (loc.modal === 'canteen-modal') updateCanteen();
          showModal(loc.modal);
        }
      } else {
        $('interaction').style.display = 'block';
      }
    }

    function showPlantMenu() {
      let hasSeeds = false;
      ['cai', 'muop', 'du_du'].forEach(type => {
        const display = state.seeds[type] > 0 ? 'inline' : 'none';
        $(`plant-${type}`).style.display = display;
        if (display === 'inline') hasSeeds = true;
      });
      $('quick-plant-btn').style.display = hasSeeds ? 'inline' : 'none';
      $('no-seeds-msg').style.display = hasSeeds ? 'none' : 'inline';
      showModal('plant-menu');
    }

    function showQuickPlantMenu() {
      closeModal('plant-menu');
      ['cai', 'muop', 'du_du'].forEach(type => {
        $(`quick-plant-${type}`).style.display = state.seeds[type] > 0 ? 'inline' : 'none';
      });
      showModal('quick-plant-menu');
    }

    function confirmUnlock(confirm) {
      closeModal('unlock-modal');
      if (confirm) {
        const cost = CONFIG.COSTS.LOCK_BASE + state.currentUnlockIndex * CONFIG.COSTS.LOCK_INCREMENT;
        if (state.money >= cost) {
          state.money -= cost;
          updateMoney();
          for (let row = 0; row < CONFIG.GRID.HEIGHT; row++) {
            for (let col = CONFIG.FARM.START_COL; col < CONFIG.GRID.WIDTH; col++) {
              if (state.cells[row][col]?.type === 'locked') {
                state.cells[row][col] = { type: 'plantable', planted: false, plantType: null, plantDay: null, ripe: false, weed: false, pest: false, affectedDay: null, watered: false, fertilized: false, harvestCount: 0 };
                const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                cell.classList.remove('locked');
                cell.classList.add('plantable');
                cell.innerText = '';
                state.unlockedCells++;
                return;
              }
            }
          }
        } else {
          showModal('insufficient-modal');
        }
      }
    }

    // Info Modal
    function updateInfo() {
      $('player-name').innerText = state.player.name;
      $('player-age').innerText = state.player.age;
      $('player-rank').innerText = state.player.rank;
      $('start-date').innerText = state.game.startDate.toLocaleDateString();
      $('countdown').innerText = `${state.game.daysLeft} ng√†y`;
      $('stamina').innerText = state.stamina;
      const progress = $('rank-progress');
      if (state.player.rankIndex === CONFIG.RANKS.length - 1) {
        progress.innerText = '(ƒê√£ ƒë·∫°t c·∫•p b·∫≠c cao nh·∫•t)';
      } else if (state.player.rankIndex === 0) {
        state.player.rankProgress = ((CONFIG.INITIAL.DAYS_LEFT - state.game.daysLeft) / 640) * 100;
        progress.innerText = `(${Math.min(100, state.player.rankProgress.toFixed(2))}% - C√≤n ${640 - (CONFIG.INITIAL.DAYS_LEFT - state.game.daysLeft)} ng√†y)`;
      } else {
        state.player.rankProgress = (state.player.completedTasks / CONFIG.TASK_COMPLETIONS[state.player.rankIndex]) * 100;
        progress.innerText = `(${Math.min(100, state.player.rankProgress.toFixed(2))}% - C√≤n ${CONFIG.TASK_COMPLETIONS[state.player.rankIndex] - state.player.completedTasks} nhi·ªám v·ª•)`;
      }
    }

    // Warehouse
    function updateWarehouse() {
      const content = $('warehouse-content');
      const items = [
        { type: 'cai', sellOne: 'sell-cai-one-btn', eat: 'eat-cai-btn', sellAll: 'sell-cai-all-btn' },
        { type: 'muop', sellOne: 'sell-muop-one-btn', eat: 'eat-muop-btn', sellAll: 'sell-muop-all-btn' },
        { type: 'du_du', sellOne: 'sell-du_du-one-btn', eat: 'eat-du_du-btn', sellAll: 'sell-du_du-all-btn' },
        { type: 'cai_luoc', sellOne: 'sell-cai_luoc-one-btn', eat: 'eat-cai_luoc-btn', sellAll: 'sell-cai_luoc-all-btn' },
        { type: 'canh_muop', sellOne: 'sell-canh_muop-one-btn', eat: 'eat-canh_muop-btn', sellAll: 'sell-canh_muop-all-btn' },
        { type: 'du_du_xao', sellOne: 'sell-du_du_xao-one-btn', eat: 'eat-du_du_xao-btn', sellAll: 'sell-du_du_xao-all-btn' }
      ];
      const inventoryText = items
        .filter(item => (['cai', 'muop', 'du_du'].includes(item.type) ? state.veggies : state.dishes)[item.type] > 0)
        .map(item => {
          const count = (['cai', 'muop', 'du_du'].includes(item.type) ? state.veggies : state.dishes)[item.type];
          $(item.sellOne).style.display = count > 0 ? 'inline' : 'none';
          $(item.eat).style.display = count > 0 ? 'inline' : 'none';
          $(item.sellAll).style.display = count > 0 ? 'inline' : 'none';
          return `${getItemName(item.type)}: ${count}`;
        });
      content.innerText = inventoryText.length ? inventoryText.join('\n') : 'Kho tr·ªëng';
    }

    // Restart Game
    function restartGame() {
      localStorage.removeItem('tangGiaNao');
      window.location.reload();
    }

    // Window Resize
    window.addEventListener('resize', () => {
      updatePlayerPosition();
    });
  </script>
</body>
</html>
